---
description: Testing standards – Vitest, code coverage requirements (80%+), TDD practices
globs: src/**/*.test.ts,src/**/*.spec.ts,src/**/*.test.svelte.ts,vitest.config.ts
alwaysApply: false
---

# Testing Standards

## Coverage Requirements (MANDATORY)

All code changes MUST maintain the following coverage thresholds measured by `pnpm test:coverage`:

| Metric | Threshold | Current |
|--------|-----------|---------|
| Lines | **>= 80%** | 88.56% |
| Functions | **>= 80%** | 98.21% |
| Statements | **>= 80%** | 88.56% |
| Branches | **>= 70%** | 74.45% |

### Coverage Enforcement
- **CI will fail** if coverage drops below thresholds
- CodeCov reports are uploaded automatically on PRs and releases
- Reviewers must verify coverage report before approving PRs

## Test-Driven Development (TDD)

### Required Workflow
1. **Write tests first** before implementing new features
2. **Run tests** to confirm they fail (red phase)
3. **Implement code** to make tests pass (green phase)
4. **Run `pnpm lint`** to check code style and fix any issues
5. **Refactor** while keeping tests green and linting clean
6. **Run full coverage report** before committing

### Test Update Requirement
- **Every code change** MUST include corresponding test updates
- Bug fixes require a failing test that reproduces the bug
- Refactoring requires existing tests to pass without modification
- New features require comprehensive test coverage

## Test File Location

Co-locate tests next to the module they test (adjacent file pattern):

```
src/lib/utils.ts
src/lib/utils.test.ts          # <-- Test file

src/lib/server/github.ts
src/lib/server/github.test.ts   # <-- Test file
```

## Test Naming Conventions

### File Names
- Unit tests: `{module}.test.ts`
- Server tests: `{module}.test.ts` in `src/lib/server/`
- Group related tests in `describe()` blocks

### Test Descriptions
Use clear, descriptive test names that explain behavior:

```typescript
// ✅ Good
describe('computeDurationMs', () => {
  it('returns null when either date is missing', () => {});
  it('returns null when end date is before start date', () => {});
  it('computes correct duration in milliseconds', () => {});
});

// ❌ Bad
describe('computeDurationMs', () => {
  it('works', () => {});
  it('handles edge cases', () => {});
});
```

## What to Test (Priority Order)

### Critical Paths (100% Coverage Required)
1. `src/lib/utils.ts` – All utility functions
2. `src/lib/server/github.ts` – All exported functions
3. `src/lib/server/workflow-graph.ts` – Graph building logic
4. `src/lib/server/mistral.ts` – AI integration
5. `src/lib/server/kv-cache.ts` – Cache operations
6. `src/lib/server/workflow-runs-cache.ts` – Supabase caching

### API Endpoint Tests
- `/api/optimize` – Auth guards (401 for unauthenticated, 400 for missing API key)
- `/api/dashboard/data` – Response format validation
- Auth callback – Token exchange and DB write logic

### Testing Patterns

#### Pure Functions (Easy to Test)
```typescript
import { describe, it, expect } from 'vitest';
import { computeDurationMs, percentile } from './utils';

describe('computeDurationMs', () => {
  it('returns null when either date is missing', () => {
    expect(computeDurationMs(null, '2024-01-01T00:01:00Z')).toBeNull();
    expect(computeDurationMs('2024-01-01T00:00:00Z', null)).toBeNull();
  });

  it('computes correct duration', () => {
    expect(computeDurationMs('2024-01-01T00:00:00Z', '2024-01-01T00:01:30Z'))
      .toBe(90_000);
  });

  it('returns null for invalid dates', () => {
    expect(computeDurationMs('invalid', '2024-01-01T00:00:00Z')).toBeNull();
  });
});
```

#### Mocking External APIs
```typescript
import { describe, it, expect, vi } from 'vitest';

// Mock at the module boundary
vi.mock('@octokit/rest', () => ({
  Octokit: vi.fn().mockImplementation(() => ({
    rest: {
      actions: {
        listRepoWorkflows: vi.fn().mockResolvedValue({
          data: { workflows: [] }
        })
      }
    }
  }))
}));

vi.mock('ai', () => ({
  generateObject: vi.fn(),
  generateText: vi.fn()
}));

// Mock Supabase with chain methods
const createMockSupabase = () => ({
  from: vi.fn().mockReturnValue({
    select: vi.fn().mockReturnValue({
      eq: vi.fn().mockReturnValue({
        maybeSingle: vi.fn().mockResolvedValue({ data: null, error: null })
      })
    }),
    upsert: vi.fn().mockReturnValue({
      select: vi.fn().mockReturnValue({
        limit: vi.fn().mockResolvedValue({ data: [{ id: 1 }], error: null })
      })
    })
  })
});
```

## Linting Requirements (MANDATORY)

**You MUST run `pnpm lint` after every code change.**

### Linting Rules
- All code must pass ESLint before committing
- No warnings or errors allowed in committed code
- Fix auto-fixable issues with `pnpm lint --fix`
- Manual fixes required for non-auto-fixable issues

### Lint Commands
```bash
pnpm lint              # Check for lint errors
pnpm lint --fix        # Auto-fix lint errors where possible
```

### Pre-Commit Lint Check
Before committing, verify lint passes:
```bash
pnpm lint && echo "✅ Lint passed" || echo "❌ Lint failed - fix errors before committing"
```

## Running Tests

### During Development
```bash
pnpm test              # Run tests once
pnpm test:watch        # Run tests in watch mode
pnpm test:coverage     # Run tests with coverage report
```

### Pre-Commit Checklist
Before committing any code, you MUST run these commands in order:

```bash
pnpm check             # TypeScript + Svelte check
pnpm lint              # ESLint (REQUIRED after every change)
pnpm test:coverage     # Tests + coverage (must pass thresholds)
```

**Linting is mandatory** - No code should be committed with lint errors. Run `pnpm lint` after every change and fix all issues before committing.

## Coverage Report Analysis

After running `pnpm test:coverage`, review the table:

```
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
-------------------|---------|----------|---------|---------|-------------------
All files          |   88.56 |    74.45 |   98.21 |   88.56 |
 lib               |     100 |      100 |     100 |     100 |
  utils.ts         |     100 |      100 |     100 |     100 |
 lib/server        |   87.52 |    68.13 |   97.67 |   87.52 |
  github.ts        |   83.37 |    59.09 |      96 |   83.37 | ...1017,1040-1071
```

**Action required**: If any file shows coverage below 80% for lines/functions/statements, add tests before committing.

## CodeCov Integration

Coverage reports are automatically uploaded to CodeCov on:
- Every pull request (PR comment with coverage diff)
- Every release

**PR Requirements**:
- Coverage must not decrease from base branch
- New code must meet 80% coverage threshold
- Reviewers check CodeCov report before approval

## Edge Cases to Always Test

### Date/Duration Functions
- Null/undefined inputs
- Invalid date strings
- Zero duration
- Negative duration (end before start)
- Very large durations

### GitHub API Functions
- Empty response arrays
- Pagination edge cases
- 401 unauthorized errors
- Rate limiting scenarios

### Cache Functions
- Cache miss (null return)
- Cache hit (fresh data)
- Stale cache (past TTL but within stale window)
- Expired cache (past stale TTL)
- Parse errors (invalid JSON)
- Network/connection errors

### YAML Parsing
- Empty YAML
- Invalid/malformed YAML
- Missing required fields
- Circular dependencies
- Template expressions (`${{ }}`)

## Test Isolation

- Each test should be independent (no shared state)
- Use `beforeEach` to reset mocks:
```typescript
import { vi, beforeEach } from 'vitest';

beforeEach(() => {
  vi.clearAllMocks();
});
```

- Mock external dependencies, never call real APIs in tests
- Use `environment: 'node'` in vitest.config.ts for server tests

## CI Requirements

The following must pass in CI before merging:

```bash
pnpm check                    # svelte-check + tsc
pnpm lint                     # ESLint
pnpm test:coverage            # Vitest with coverage thresholds
pnpm audit --audit-level=high # No high/critical vulnerabilities
```

Failure of any check blocks merge.
