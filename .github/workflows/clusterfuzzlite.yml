name: ClusterFuzzLite

on:
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '30 2 * * 0'

# Declare default permissions as read only.
permissions: read-all

jobs:
  cflite-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build fuzzers
        id: build
        uses: google/clusterfuzzlite/actions/build_fuzzers@v1
        with:
          language: javascript
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Run code-change fuzzing
        id: run
        uses: google/clusterfuzzlite/actions/run_fuzzers@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          mode: code-change
          fuzz-seconds: 600
        continue-on-error: true

  cflite-batch:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Build fuzzers
        id: build
        uses: google/clusterfuzzlite/actions/build_fuzzers@v1
        with:
          language: javascript
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Run batch fuzzing
        id: run
        uses: google/clusterfuzzlite/actions/run_fuzzers@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          mode: batch
          fuzz-seconds: 1800
        continue-on-error: true
